{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/having-fun-in-the-eternal-fight-against-the-ads/","webpackCompilationHash":"772700f46e23d6ee1645","result":{"data":{"markdownRemark":{"id":"bd895cc8-112a-5509-b490-0c5708a1b0fb","html":"<p>I usually read news on <a href=\"https://elpais.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">elpais.com</a>. I reach them through Twitter links because it’s one of the news account I follow.</p>\n<p>Some time ago they added a big anti adblock banner in the middle of the page that was displayed every time you loaded a page if you had adblock installed and enabled. At that time I didn’t know the adblock feature that includes an option in the contextual menu to block an element on the page, so I created <a href=\"https://chrome.google.com/webstore/detail/agm-chrome-extension/bpjmkofdilcfhaafpkokkanpppcblddf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">my own and personal chrome extension</a> and added a script that is executed only on <code class=\"language-text\">elpais.com</code> domains, and disables the banner.</p>\n<p>The code removes the banner element and enables scrolling again:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> overlay <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.fc-ab-root'</span><span class=\"token punctuation\">)</span>\noverlay<span class=\"token punctuation\">.</span>parentElement<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>overlay<span class=\"token punctuation\">)</span>\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>overflow <span class=\"token operator\">=</span> <span class=\"token string\">'scroll'</span></code></pre></div>\n<p>It was simple because the class was always the same.</p>\n<p>But today I visited their page, following some random link on Twitter, and this is what I found…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 691px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aac3992899595d7070971cc0397d187a/097e8/anti-adblock-01.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.74529667149059%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB24MW4P/EABcQAAMBAAAAAAAAAAAAAAAAAAAQISL/2gAIAQEAAQUCppf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAADAQEAAAAAAAAAAAAAAAAAASERgf/aAAgBAQABPyFvcOCn/9oADAMBAAIAAwAAABB8P//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EIf/xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8QrKz/xAAYEAEBAQEBAAAAAAAAAAAAAAABABEhYf/aAAgBAQABPxBjGZ7DA46u3//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/aac3992899595d7070971cc0397d187a/01472/anti-adblock-01.webp 240w,\n/static/aac3992899595d7070971cc0397d187a/222bd/anti-adblock-01.webp 480w,\n/static/aac3992899595d7070971cc0397d187a/ca360/anti-adblock-01.webp 691w\"\n          sizes=\"(max-width: 691px) 100vw, 691px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/aac3992899595d7070971cc0397d187a/3bc27/anti-adblock-01.jpg 240w,\n/static/aac3992899595d7070971cc0397d187a/98431/anti-adblock-01.jpg 480w,\n/static/aac3992899595d7070971cc0397d187a/097e8/anti-adblock-01.jpg 691w\"\n          sizes=\"(max-width: 691px) 100vw, 691px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/aac3992899595d7070971cc0397d187a/097e8/anti-adblock-01.jpg\"\n          alt=\"Anti adblock elpais.com\"\n          title=\"Anti adblock elpais.com\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>Yeeep… there we go again…</p>\n<p>But it doesn’t matter. I always enjoy the opportunity to open Chrome Dev Tools and play with Javascript and the DOM.</p>\n<p>When I inspect the element I find this time it uses a random class name.</p>\n<p>If we check the classes of the div elements in the page we notice that there are a lot of divs at the end of the page with random class names.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// code to get and print all classes used by div elements in the page</span>\n<span class=\"token keyword\">let</span> classes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  classes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>classes<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>el<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span>classes<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The weak point here is that all random generated classes have the same length… 12 characters length.</p>\n<p>So we can remove duplicates and filter our <code class=\"language-text\">classes</code> content to get the random classes used:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// removes the duplicates and takes only the 12 length class names</span>\n<span class=\"token keyword\">const</span> suspiciousClasses <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>new <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>classes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">i</span> <span class=\"token operator\">=></span> i<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This reduces the 220 count to around 30. But includes some legitim class names that match our “twelve characters length” rule. We can remove them if we notice that the random classes don’t use whitespaces or underscores.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// removes 12 characters length class names with whitespaces or underscores</span>\n<span class=\"token keyword\">const</span> randomClasses <span class=\"token operator\">=</span> suspiciousClasses<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">i</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\s|_/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>And now we can just find the elements that use those classes and remove them:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// remove all suspicious elements</span>\nsuspiciousClasses<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">className</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">div.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>className<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    elements<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'removing suspicious element...'</span><span class=\"token punctuation\">)</span>\n      el<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>I wrap the code into a <code class=\"language-text\">try/catch</code> block because some random generated classes will produce a javascript error (<code class=\"language-text\">div.123random</code>), because it seems querySelectors can’t start with a number. We could write the sentence like this <code class=\"language-text\">document.querySelectorAll(&quot;[class=&#39;123random&#39;]&quot;)</code> and it would work, but I prefer the <code class=\"language-text\">try/catch</code> approach.</p>\n<p>So, I have grouped all this logic into a function and added it to the current flow of my <a href=\"https://chrome.google.com/webstore/detail/agm-chrome-extension/bpjmkofdilcfhaafpkokkanpppcblddf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">agm-chrome-extension</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">removeSuspiciousElements</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isSuspicious</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">className</span> <span class=\"token operator\">=></span> className<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\s|_/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">let</span> rawClasses <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    rawClasses <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>rawClasses<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>el<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// remove duplicates</span>\n  <span class=\"token keyword\">const</span> uniqueClasses <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>new <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>rawClasses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> suspiciousClasses <span class=\"token operator\">=</span> uniqueClasses<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isSuspicious<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// remove all suspicious elements</span>\n  suspiciousClasses<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">className</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">div.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>className<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      elements<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'removing suspicious element...'</span><span class=\"token punctuation\">)</span>\n        el<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And it just works :D</p>\n<p>So now I can continue reading news without disturbing and useless warnings :)</p>\n<h2 id=\"what-if-they-randomize-the-length-of-the-generated-classes\"><a href=\"#what-if-they-randomize-the-length-of-the-generated-classes\" aria-label=\"what if they randomize the length of the generated classes permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What if they randomize the length of the generated classes?</h2>\n<p>I have two ideas to solve this problem, but I would have to explore it to check if they are viable. I’ll do it when they evolve their banners in this direction.</p>\n<ol>\n<li>Download and parse the stylesheets. The random generated classes won’t be there, so we could get all document classes and discard all classes present on the stylesheets.</li>\n<li>Use some dictionary or apply some kind of machine learning to identify random strings, then process the classes to find the random ones.</li>\n</ol>","fields":{"slug":"/posts/having-fun-in-the-eternal-fight-against-the-ads/","tagSlugs":["/tag/programming/","/tag/javascript/","/tag/dom/","/tag/dom-manipulation/","/tag/adblocker/","/tag/elpais/","/tag/chrome-extension/"]},"frontmatter":{"date":"2019-10-01T18:30:32.169Z","description":"I find a new anti adblock warning on my usual news webpage and figure how to remove the warning by using javascript","tags":["programming","javascript","DOM","DOM manipulation","adblocker","elpais","chrome extension"],"title":"Having fun in the eternal fight against the ads","socialImage":"/media/gary-clark-jr-2019.jpg"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/having-fun-in-the-eternal-fight-against-the-ads/"}}}